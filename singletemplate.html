<style>
#action-menu-2 {
float: right;
}
</style>
                <div id="import-area" hidden>[[json]]</div>

<div class="container">
##actionsmenu##
    <h1 class="mb-4">Beobachtung</h1>

    <div class="mb-3">
        <button type="button" 
                id="addObservation" 
                class="btn btn-primary"
                data-bs-toggle="modal" 
                data-bs-target="#observationModal"
                onclick="prepareNewObservation()" hidden>
            Neue Beobachtung hinzufügen
        </button>
        <button type="button" 
                id="exportSVG" 
                class="btn btn-secondary ms-2">
            <i class="fa-solid fa-download"></i>
        </button>
    </div>

    <div id="chartContainer" style="overflow-x:auto;max-width: 100%;">
        <svg id="chart" height="500"></svg>
    </div>

    <div class="mt-5">
         <div class="table-responsive">
      <table class="table table-bordered table-striped" id="observationTable">
              <thead class="table-dark">
                    <tr>
  <th><i class="fa-regular fa-clock"></i></th>
                        <th><i class="fa-regular fa-percent"></i></th>
                        <th><i class="fa-regular fa-comment"></i></th>
                        <th></th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div id="noData" class="text-muted">Noch keine Beobachtungen vorhanden.</div>
    </div>

    <div class="mt-4" hidden>
        <h5>Gespeicherte Beobachtungen (JSON):</h5>
      <input class="basefieldinput form-control d-inline mod-data-input" type="text" name="json##id##" id="json##id##" value=''>
    </div>

</div>

<div class=" added_field" hidden>
    <div class="mt-4">
        <span class="fw-bold">[[color#name]]</span>
        <p class="mt-2">[[color]]</p>
    </div>
</div><div class=" added_field">
    <div class="mt-4">
        <p class="mt-2">[[notes]]</p>
    </div>
<!-- Modal -->
<div class="modal fade" id="observationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fa-regular fa-eye"></i></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <input type="text" id="timeInput" class="form-control" placeholder="z.B. 09:15" readonly>
                </div>
                <div class="mb-4">
                    <div class="d-flex align-items-center">
                        <input type="range" class="form-range me-3" min="0" max="100" step="10" id="engagementSlider" hidden>
                        <span id="engagementValue" style="font-weight:bold; min-width:40px; text-align:center;">50</span> %
                    </div>
                </div>
                <div class="mb-3">
                    <textarea id="textInput" class="form-control" rows="5" readonly></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" hidden>Abbrechen</button>
                <button type="button" id="saveObservation" class="btn btn-primary" data-bs-dismiss="modal" hidden>Speichern</button>
                <button type="button" id="deleteObservation" class="btn btn-danger" style="display:none;" data-bs-dismiss="modal" hidden>Löschen</button>
            </div>
        </div>
    </div>
</div>
<script>

        // Hole das Quell-div und das Ziel-input
        const sourceDiv = document.getElementById('import-area');
        const targetInput = document.getElementById('json##id##');

        // Entferne HTML-Tags und hole den reinen Text
        const cleanText = sourceDiv.innerText;

        // Setze den bereinigten Text als value des input-Elements
        targetInput.value = cleanText;
</script>
<script>
    const svg = document.getElementById('chart');
    const chartContainer = document.getElementById('chartContainer');
    const height = 500;
    const margin = { top: 40, right: 60, bottom: 50, left: 60 };
    let plotHeight = height - margin.top - margin.bottom;

    const plotGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    plotGroup.setAttribute('transform', `translate(${margin.left},${margin.top})`);
    svg.appendChild(plotGroup);

    const gridGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    const pointsGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    const xAxisGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    const yAxisGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    plotGroup.appendChild(gridGroup);
    plotGroup.appendChild(pointsGroup);
    plotGroup.appendChild(xAxisGroup);
    plotGroup.appendChild(yAxisGroup);

    const tableBody = document.querySelector('#observationTable tbody');
    const noDataMsg = document.getElementById('noData');

    let observations = [];
    let currentEditIndex = -1;
    let expandedCluster = null;

    const slider = document.getElementById('engagementSlider');
    const valueDisplay = document.getElementById('engagementValue');
    slider.addEventListener('input', () => valueDisplay.textContent = slider.value);

    function formatTime(date) {
        return date.toTimeString().slice(0, 5);
    }

    function timeToMinutes(timeStr) {
        const [h, m] = timeStr.split(':').map(Number);
        return h * 60 + m;
    }

    function prepareNewObservation() {
        currentEditIndex = -1;
        document.getElementById('timeInput').value = formatTime(new Date());
        slider.value = 50;
        valueDisplay.textContent = 50;
        document.getElementById('textInput').value = '';
        document.getElementById('deleteObservation').style.display = 'none';
    }

    function fillModal(index) {
        currentEditIndex = index;
        const obs = observations[index];
        document.getElementById('timeInput').value = obs.time;
        slider.value = obs.engagement;
        valueDisplay.textContent = obs.engagement;
        document.getElementById('textInput').value = obs.text || '';
        document.getElementById('deleteObservation').style.display = 'inline-block';
    }

    // Modal öffnen – 100% Moodle-sicher, ohne bootstrap-Objekt!
    function openObservationModal(index) {
        fillModal(index);
        const btn = document.createElement('button');
        btn.setAttribute('data-bs-toggle', 'modal');
        btn.setAttribute('data-bs-target', '#observationModal');
        document.body.appendChild(btn);
        btn.click();
        document.body.removeChild(btn);
    }

    function updateTable() {
        tableBody.innerHTML = '';
        if (observations.length === 0) {
            noDataMsg.style.display = 'block';
            return;
        }
        noDataMsg.style.display = 'none';

        const sorted = [...observations].sort((a, b) => timeToMinutes(a.time) - timeToMinutes(b.time));

        sorted.forEach((obs) => {
            const originalIndex = observations.indexOf(obs);
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${obs.time}</td>
                <td>${obs.engagement}</td>
                <td>${obs.text ? obs.text.replace(/</g, '&lt;') : '–'}</td>
                <td>
                    <button type="button" class="btn btn-sm btn-outline-primary"
                            data-bs-toggle="modal" data-bs-target="#observationModal"
                            onclick="openObservationModal(${originalIndex})">
                        <i class="fa-regular fa-eye"></i>
                    </button>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }


    function updateChart() {
        gridGroup.innerHTML = '';
        pointsGroup.innerHTML = '';
        xAxisGroup.innerHTML = '';
        yAxisGroup.innerHTML = '';
        if (expandedCluster) expandedCluster.remove();

        const jsonField = document.getElementById('json##id##');
        if (jsonField) {
            jsonField.value = observations.length === 0 ? '[]' : JSON.stringify(observations);
        }

        updateTable();

        if (observations.length === 0) {
            svg.setAttribute('width', 900);
            return;
        }

        const minutesArray = observations.map(o => timeToMinutes(o.time));
        let minMinutes = Math.min(...minutesArray) - 5;
        let maxMinutes = Math.max(...minutesArray) + 5;
        minMinutes = Math.floor(minMinutes / 5) * 5;
        maxMinutes = Math.ceil(maxMinutes / 5) * 5;

        const totalMinutes = maxMinutes - minMinutes;
        const pixelsPer10Min = 250;
        let plotWidth = totalMinutes * (pixelsPer10Min / 10);
        plotWidth = Math.max(plotWidth, 840);

        const width = plotWidth + margin.left + margin.right;
        svg.setAttribute('width', width);
        chartContainer.style.width = width + 'px';
        plotHeight = height - margin.top - margin.bottom;

        const xScale = m => (m - minMinutes) / totalMinutes * plotWidth;
        const yScale = v => plotHeight - ((v + 5) / 110) * plotHeight;

    gridGroup.innerHTML = '';
    xAxisGroup.innerHTML = '';
    yAxisGroup.innerHTML = '';

        xAxisGroup.setAttribute('transform', `translate(0,${plotHeight})`);

        for (let m = minMinutes; m <= maxMinutes; m += 5) {
            const x = xScale(m);
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', x); line.setAttribute('y1', 0);
            line.setAttribute('x2', x); line.setAttribute('y2', plotHeight);
            line.setAttribute('stroke', '#eee');
            gridGroup.appendChild(line);

        if (m % 10 === 0) {
            const h = String(Math.floor(m / 60)).padStart(2, '0');
            const min = String(m % 60).padStart(2, '0');
            const txt = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            txt.setAttribute('x', x); txt.setAttribute('y', 20);
            txt.setAttribute('text-anchor', 'middle');
            txt.setAttribute('font-size', '12');
            txt.textContent = `${h}:${min}`;
            xAxisGroup.appendChild(txt);
        }
    }
    // Y-Achse
    for (let p = 0; p <= 100; p += 10) {
        const y = yScale(p);
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', 0); line.setAttribute('y1', y);
        line.setAttribute('x2', plotWidth); line.setAttribute('y2', y);
        line.setAttribute('stroke', '#eee');
        gridGroup.appendChild(line);

        const txt = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        txt.setAttribute('x', -10); txt.setAttribute('y', y + 5);
        txt.setAttribute('text-anchor', 'end');
        txt.setAttribute('font-size', '12');
        txt.textContent = p;
        yAxisGroup.appendChild(txt);
    }

        if (!svg.querySelector('text[y="-40"]')) {
            const yLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            yLabel.setAttribute('transform', 'rotate(-90)');
            yLabel.setAttribute('x', -plotHeight/2 - margin.top);
            yLabel.setAttribute('y', -40);
            yLabel.setAttribute('text-anchor', 'middle');
            yLabel.textContent = 'Engagement (%)';
            svg.appendChild(yLabel);
        }

        // Clustering
        const groups = {};
        observations.forEach((obs, i) => {
            const key = `${obs.time}|${obs.engagement}`;
            if (!groups[key]) groups[key] = [];
            groups[key].push(i);
        });

        Object.values(groups).forEach(indices => {
            const first = observations[indices[0]];
            const cx = xScale(timeToMinutes(first.time));
            const cy = yScale(first.engagement);

            if (indices.length === 1) {
                const c = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                c.setAttribute('cx', cx); c.setAttribute('cy', cy);
                c.setAttribute('r', 12); c.setAttribute('fill', '[[color]]');
                c.setAttribute('stroke', '#000');
               c.setAttribute('stroke-width', 2);
                c.style.cursor = 'pointer';
                c.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openObservationModal(indices[0]);
                });
                pointsGroup.appendChild(c);
            } else {
          const count = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    const cluster = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    cluster.setAttribute('cx', cx);
    cluster.setAttribute('cy', cy);
    cluster.setAttribute('r', 16);
    cluster.setAttribute('fill', '#dc3545');
    cluster.setAttribute('opacity', '0.9');
    cluster.style.cursor = 'pointer';
    pointsGroup.appendChild(cluster);
    count.setAttribute('x', cx);
    count.setAttribute('y', cy + 5);
    count.setAttribute('text-anchor', 'middle');
    count.setAttribute('fill', 'white');
    count.setAttribute('font-weight', 'bold');
    count.setAttribute('font-size', '14');
    count.textContent = indices.length;
    count.style.pointerEvents = 'none';
    pointsGroup.appendChild(count);
                cluster.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (expandedCluster) expandedCluster.remove();

                    expandedCluster = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                    pointsGroup.appendChild(expandedCluster);

                    const radius = 60;
                    indices.forEach((idx, i) => {
                        const angle = (i / indices.length) * 2 * Math.PI;
                        const px = cx + radius * Math.cos(angle);
                        const py = cy + radius * Math.sin(angle);

                        const p = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                        p.setAttribute('cx', px); p.setAttribute('cy', py);
                        p.setAttribute('r', 12); p.setAttribute('fill', '[[color]]');
                        p.style.cursor = 'pointer';
                        p.setAttribute('opacity', '0.9');
                        p.setAttribute('stroke', '#000');
                        p.addEventListener('click', (e) => {
                            e.stopPropagation();
                            openObservationModal(idx);
                        });
                        expandedCluster.appendChild(p);
                    });

                    const close = (e) => {
                        if (!expandedCluster.contains(e.target)) {
                            expandedCluster.remove();
                            expandedCluster = null;
                            document.removeEventListener('click', close);
                        }
                    };
                    setTimeout(() => document.addEventListener('click', close), 0);
                });
            }
        });
// === GESTRICHELTE VERBINDUNGSLINIEN (in der Einzelansicht) ===
if (observations.length >= 2) {
    // Beobachtungen nach Zeit sortieren
    const sortedObs = [...observations].sort((a, b) => 
        timeToMinutes(a.time) - timeToMinutes(b.time)
    );

    for (let i = 0; i < sortedObs.length - 1; i++) {
        const obs1 = sortedObs[i];
        const obs2 = sortedObs[i + 1];

        const x1 = xScale(timeToMinutes(obs1.time));
        const y1 = yScale(obs1.engagement);
        const x2 = xScale(timeToMinutes(obs2.time));
        const y2 = yScale(obs2.engagement);

        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', x1);
        line.setAttribute('y1', y1);
        line.setAttribute('x2', x2);
        line.setAttribute('y2', y2);
        line.setAttribute('stroke', '[[color]]');           // Deine Gruppenfarbe
        line.setAttribute('stroke-width', '2');
        line.setAttribute('stroke-dasharray', '6 4');       // Gestrichelt: 6px Strich, 4px Lücke
        line.setAttribute('opacity', '0.7');                // Etwas transparent
        line.setAttribute('pointer-events', 'none');        // Klicks gehen durch

        // Linien hinter die Punkte legen
        pointsGroup.insertBefore(line, pointsGroup.firstChild);
    }
}
    }

    document.getElementById('saveObservation').addEventListener('click', () => {
        const time = document.getElementById('timeInput').value.trim();
        const engagement = parseInt(slider.value);
        const text = document.getElementById('textInput').value.trim();

        if (!/^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/.test(time)) {
            alert('Bitte gültige Uhrzeit im Format HH:MM eingeben');
            return;
        }

        const obs = { time, engagement, text };
        if (currentEditIndex === -1) {
            observations.push(obs);
        } else {
            observations[currentEditIndex] = obs;
        }
        updateChart();
    });

    document.getElementById('deleteObservation').addEventListener('click', () => {
        if (currentEditIndex !== -1 && confirm('Beobachtung wirklich löschen?')) {
            observations.splice(currentEditIndex, 1);
            updateChart();
        }
    });

    document.getElementById('exportSVG').addEventListener('click', () => {
        if (expandedCluster) expandedCluster.remove();
        const serializer = new XMLSerializer();
        const source = serializer.serializeToString(svg);
        const blob = new Blob([source], {type: 'image/svg+xml'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'engagement-diagramm.svg';
        a.click(); URL.revokeObjectURL(url);
    });

    // JSON laden
    const jsonField = document.getElementById('json##id##');
    if (jsonField && jsonField.value && jsonField.value.trim() !== '' && jsonField.value.trim() !== '[]') {
        try {
            observations = JSON.parse(jsonField.value);
        } catch (e) {
            console.error('Ungültiges JSON:', e);
            observations = [];
        }
    }

    updateChart();
</script>
</div>